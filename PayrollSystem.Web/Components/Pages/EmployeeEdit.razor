@page "/employees/{EmployeeId:int}/edit"
@using PayrollSystem.Core.Entities.People
@using PayrollSystem.Infrastructure.Data
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize]
@rendermode Microsoft.AspNetCore.Components.Web.RenderMode.InteractiveServer
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Edit Employee - Payroll System</PageTitle>

@if (isLoading)
{
    <MudProgressCircular Indeterminate="true" />
}
else if (employee == null)
{
    <MudAlert Severity="Severity.Error">Employee not found</MudAlert>
    <MudButton Href="/employees" Variant="Variant.Text" Class="mt-4">
        <MudIcon Icon="@Icons.Material.Filled.ArrowBack" Class="mr-2" />
        Back to Employees
    </MudButton>
}
else
{
    <MudText Typo="Typo.h3" Class="mb-4">Edit Employee: @employee.FirstName @employee.LastName</MudText>

    <MudPaper Class="pa-4">
        <MudGrid>
            <!-- Personal Information Section -->
            <MudItem xs="12">
                <MudText Typo="Typo.h6" Class="mb-2">Personal Information</MudText>
                <MudDivider Class="mb-4" />
            </MudItem>

            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="firstName" 
                              Label="First Name" 
                              Required="true"
                              Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="middleName" 
                              Label="Middle Name" 
                              Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="lastName" 
                              Label="Last Name" 
                              Required="true"
                              Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="preferredName" 
                              Label="Preferred Name (Optional)" 
                              Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="dateOfBirthString" 
                              Label="Date of Birth (YYYY-MM-DD)" 
                              Required="true"
                              Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="gender" 
                              Label="Gender" 
                              Required="true"
                              Variant="Variant.Outlined"
                              HelperText="Male, Female, Other, Prefer not to say" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="nationality" 
                              Label="Nationality" 
                              Required="true"
                              Variant="Variant.Outlined" />
            </MudItem>

            <!-- Contact Information Section -->
            <MudItem xs="12">
                <MudText Typo="Typo.h6" Class="mb-2 mt-4">Contact Information</MudText>
                <MudDivider Class="mb-4" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="email" 
                              Label="Work Email" 
                              InputType="InputType.Email"
                              Required="true"
                              Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="personalEmail" 
                              Label="Personal Email" 
                              InputType="InputType.Email"
                              Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="phone" 
                              Label="Phone" 
                              Required="true"
                              Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="mobilePhone" 
                              Label="Mobile Phone" 
                              Variant="Variant.Outlined" />
            </MudItem>

            <!-- Address Section -->
            <MudItem xs="12">
                <MudText Typo="Typo.h6" Class="mb-2 mt-4">Address</MudText>
                <MudDivider Class="mb-4" />
            </MudItem>

            <MudItem xs="12">
                <MudTextField @bind-Value="address" 
                              Label="Street Address" 
                              Required="true"
                              Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="city" 
                              Label="City" 
                              Required="true"
                              Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="state" 
                              Label="State/Province" 
                              Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="zipCode" 
                              Label="ZIP/Postal Code" 
                              Required="true"
                              Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="country" 
                              Label="Country" 
                              Required="true"
                              Variant="Variant.Outlined" />
            </MudItem>

            <!-- Emergency Contact Section -->
            <MudItem xs="12">
                <MudText Typo="Typo.h6" Class="mb-2 mt-4">Emergency Contact</MudText>
                <MudDivider Class="mb-4" />
            </MudItem>

            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="emergencyContactName" 
                              Label="Name" 
                              Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="emergencyContactPhone" 
                              Label="Phone" 
                              Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="emergencyContactRelationship" 
                              Label="Relationship" 
                              Variant="Variant.Outlined" />
            </MudItem>

            <!-- Identification Section (Optional) -->
            <MudItem xs="12">
                <MudText Typo="Typo.h6" Class="mb-2 mt-4">Identification (Optional)</MudText>
                <MudDivider Class="mb-4" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="ssn" 
                              Label="SSN / National ID" 
                              Variant="Variant.Outlined"
                              HelperText="Will be encrypted" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="passportNumber" 
                              Label="Passport Number" 
                              Variant="Variant.Outlined"
                              HelperText="Will be encrypted" />
            </MudItem>

            <!-- Action Buttons -->
            <MudItem xs="12">
                <MudDivider Class="my-4" />
                <MudStack Row="true" Spacing="2">
                    <MudButton OnClick="HandleSave" 
                               Variant="Variant.Filled" 
                               Color="Color.Primary"
                               Disabled="@isSaving"
                               StartIcon="@Icons.Material.Filled.Save">
                        @if (isSaving)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>Saving...</span>
                        }
                        else
                        {
                            <span>Save Changes</span>
                        }
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" 
                               Color="Color.Default"
                               OnClick="Cancel"
                               Disabled="@isSaving"
                               StartIcon="@Icons.Material.Filled.Cancel">
                        Cancel
                    </MudButton>
                </MudStack>
            </MudItem>
        </MudGrid>
    </MudPaper>
}

@code {
    [Parameter]
    public int EmployeeId { get; set; }

    private Employee? employee;
    private bool isLoading = true;
    private bool isSaving = false;

    // Form fields
    private string firstName = "";
    private string middleName = "";
    private string lastName = "";
    private string preferredName = "";
    private string email = "";
    private string personalEmail = "";
    private string phone = "";
    private string mobilePhone = "";
    private string dateOfBirthString = "";
    private string gender = "";
    private string nationality = "";
    private string ssn = "";
    private string passportNumber = "";
    private string address = "";
    private string city = "";
    private string state = "";
    private string zipCode = "";
    private string country = "";
    private string emergencyContactName = "";
    private string emergencyContactPhone = "";
    private string emergencyContactRelationship = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            employee = await DbContext.Employees
                .FirstOrDefaultAsync(e => e.Id == EmployeeId);

            if (employee != null)
            {
                // Populate form fields
                firstName = employee.FirstName;
                middleName = employee.MiddleName ?? "";
                lastName = employee.LastName;
                preferredName = employee.PreferredName ?? "";
                email = employee.Email;
                personalEmail = employee.PersonalEmail ?? "";
                phone = employee.Phone;
                mobilePhone = employee.MobilePhone ?? "";
                dateOfBirthString = employee.DateOfBirth.ToString("yyyy-MM-dd");
                gender = employee.Gender;
                nationality = employee.Nationality;
                ssn = employee.SSN ?? "";
                passportNumber = employee.PassportNumber ?? "";
                address = employee.Address;
                city = employee.City;
                state = employee.State ?? "";
                zipCode = employee.ZipCode;
                country = employee.Country;
                emergencyContactName = employee.EmergencyContactName ?? "";
                emergencyContactPhone = employee.EmergencyContactPhone ?? "";
                emergencyContactRelationship = employee.EmergencyContactRelationship ?? "";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading employee: {ex.Message}");
            Snackbar.Add("Failed to load employee", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleSave()
    {
        if (employee == null) return;

        // Validate required fields
        if (string.IsNullOrWhiteSpace(firstName) || string.IsNullOrWhiteSpace(lastName) ||
            string.IsNullOrWhiteSpace(email) || string.IsNullOrWhiteSpace(phone))
        {
            Snackbar.Add("Please fill in all required fields", Severity.Error);
            return;
        }

        // Parse date of birth
        if (!DateTime.TryParse(dateOfBirthString, out DateTime dob))
        {
            Snackbar.Add("Invalid date format. Please use YYYY-MM-DD", Severity.Error);
            return;
        }

        isSaving = true;
        try
        {
            // Update employee
            employee.FirstName = firstName.Trim();
            employee.MiddleName = middleName?.Trim() ?? "";
            employee.LastName = lastName.Trim();
            employee.PreferredName = preferredName?.Trim() ?? "";
            employee.Email = email.Trim();
            employee.PersonalEmail = personalEmail?.Trim() ?? "";
            employee.Phone = phone.Trim();
            employee.MobilePhone = mobilePhone?.Trim() ?? "";
            employee.DateOfBirth = dob;
            employee.Gender = gender.Trim();
            employee.Nationality = nationality.Trim();
            employee.SSN = ssn?.Trim() ?? "";
            employee.PassportNumber = passportNumber?.Trim() ?? "";
            employee.Address = address.Trim();
            employee.City = city.Trim();
            employee.State = state?.Trim() ?? "";
            employee.ZipCode = zipCode.Trim();
            employee.Country = country.Trim();
            employee.EmergencyContactName = emergencyContactName?.Trim() ?? "";
            employee.EmergencyContactPhone = emergencyContactPhone?.Trim() ?? "";
            employee.EmergencyContactRelationship = emergencyContactRelationship?.Trim() ?? "";
            employee.UpdatedAt = DateTime.UtcNow;

            await DbContext.SaveChangesAsync();

            Snackbar.Add($"Employee {employee.FirstName} {employee.LastName} updated successfully!", Severity.Success);
            Navigation.NavigateTo($"/employees/{employee.Id}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating employee: {ex.Message}");
            Snackbar.Add("Failed to update employee. Please try again.", Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo($"/employees/{EmployeeId}");
    }
}
