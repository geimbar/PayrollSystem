@page "/select-tenant"
@* NO @rendermode - static page so cookies can be set *@
@attribute [AllowAnonymous]
@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@using PayrollSystem.Infrastructure.Services
@inject IAccountService AccountService
@inject NavigationManager Navigation

<PageTitle>Select Tenant - Payroll System</PageTitle>

<div class="login-container">
    <MudContainer MaxWidth="MaxWidth.Small">
        <MudPaper Elevation="3" Class="pa-8">
            <div class="text-center mb-4">
                <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Size="Size.Large" Color="Color.Primary" />
                <MudText Typo="Typo.h4" Class="mt-2">Payroll System</MudText>
            </div>

            <MudText Typo="Typo.h6" Class="mb-2">Select Organization</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                Choose which organization you want to access
            </MudText>

            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mb-4">@ErrorMessage</MudAlert>
            }

            @if (Tenants != null && Tenants.Any())
            {
                <MudStack Spacing="2">
                    @foreach (var tenant in Tenants)
                    {
                        <form method="post" @formname="@($"select-tenant-{tenant.TenantId}")" @onsubmit="() => SelectTenantMethod(tenant.TenantId, tenant.CompanyId)">
                            <AntiforgeryToken />
                            <MudPaper Outlined="true" Class="pa-4" Style="cursor: pointer;">
                                <button type="submit" style="all: unset; width: 100%; cursor: pointer;">
                                    <div class="d-flex justify-space-between align-center">
                                        <div>
                                            <MudText Typo="Typo.body1">@tenant.TenantName</MudText>
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                @tenant.CompanyName - @tenant.Role
                                            </MudText>
                                        </div>
                                        <MudIcon Icon="@Icons.Material.Filled.ChevronRight" />
                                    </div>
                                </button>
                            </MudPaper>
                        </form>
                    }
                </MudStack>
            }

            <MudButton Href="/login" Variant="Variant.Text" FullWidth="true" Class="mt-4">
                <MudIcon Icon="@Icons.Material.Filled.ArrowBack" Class="mr-2" />
                Back to Login
            </MudButton>
        </MudPaper>
    </MudContainer>
</div>

<style>
    .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 80vh;
    }
</style>

@code {
    [SupplyParameterFromQuery]
    public string Email { get; set; } = "";

    [SupplyParameterFromQuery]
    public string Password { get; set; } = "";

    [SupplyParameterFromQuery]
    public string? ErrorMessage { get; set; }

    private List<TenantSelectionDto> Tenants { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(Email))
        {
            Navigation.NavigateTo("/login");
            return;
        }

        Tenants = await AccountService.GetUserTenantsAsync(Email);

        if (!Tenants.Any())
        {
            Navigation.NavigateTo("/login?ErrorMessage=No%20organizations%20found");
        }
    }

    private async Task SelectTenantMethod(int tenantId, int? companyId)
    {
        var result = await AccountService.LoginAsync(Email, Password, tenantId, companyId);

        if (result.Success)
        {
            Navigation.NavigateTo("/", forceLoad: true);
        }
        else
        {
            Navigation.NavigateTo($"/select-tenant?email={Uri.EscapeDataString(Email)}&password={Uri.EscapeDataString(Password)}&ErrorMessage={Uri.EscapeDataString(result.ErrorMessage)}");
        }
    }
}
