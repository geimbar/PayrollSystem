@page "/employees/{EmployeeId:int}/jobs/add"
@using PayrollSystem.Core.Entities.Employment
@using PayrollSystem.Core.Entities.Core
@using PayrollSystem.Infrastructure.Data
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize]
@rendermode Microsoft.AspNetCore.Components.Web.RenderMode.InteractiveServer
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Add Job - Payroll System</PageTitle>

@if (isLoading)
{
    <MudProgressCircular Indeterminate="true" />
}
else if (employee == null)
{
    <MudAlert Severity="Severity.Error">Employee not found</MudAlert>
}
else
{
    <MudText Typo="Typo.h3" Class="mb-2">Add Job for @employee.FirstName @employee.LastName</MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
        Assign this employee to a company with a specific position
    </MudText>

    <MudPaper Class="pa-4">
        <MudGrid>
            <!-- Company Selection -->
            <MudItem xs="12">
                <MudText Typo="Typo.h6" Class="mb-2">Company & Department</MudText>
                <MudDivider Class="mb-4" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudSelect @bind-Value="selectedCompanyId"
                           Label="Company"
                           Required="true"
                           Variant="Variant.Outlined"
                           T="int?"
                           AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem T="int?" Value="null">-- Select Company --</MudSelectItem>
                    @foreach (var company in companies)
                    {
                        <MudSelectItem T="int?" Value="@company.Id">@company.CompanyName</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudSelect @bind-Value="selectedDepartmentId"
                           Label="Department (Optional)"
                           Variant="Variant.Outlined"
                           T="int?"
                           Disabled="@(!selectedCompanyId.HasValue)"
                           AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem T="int?" Value="null">-- No Department --</MudSelectItem>
                    @foreach (var dept in filteredDepartments)
                    {
                        <MudSelectItem T="int?" Value="@dept.Id">@dept.DepartmentName</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <!-- Job Details -->
            <MudItem xs="12">
                <MudText Typo="Typo.h6" Class="mb-2 mt-4">Job Details</MudText>
                <MudDivider Class="mb-4" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="jobTitle"
                              Label="Job Title"
                              Required="true"
                              Variant="Variant.Outlined"
                              Placeholder="e.g., Software Engineer, VP Engineering" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudSelect @bind-Value="employmentType"
                           Label="Employment Type"
                           Required="true"
                           Variant="Variant.Outlined"
                           T="string"
                           AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem T="string" Value="@("Full-time")">Full-time</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Part-time")">Part-time</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Contract")">Contract</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Board")">Board Member</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Consultant")">Consultant</MudSelectItem>
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudDatePicker @bind-Date="startDate"
                               Label="Start Date"
                               Required="true"
                               Variant="Variant.Outlined"
                               Editable="true" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudSelect @bind-Value="employmentStatus"
                           Label="Status"
                           Required="true"
                           Variant="Variant.Outlined"
                           T="string"
                           AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem T="string" Value="@("Active")">Active</MudSelectItem>
                    <MudSelectItem T="string" Value="@("On Leave")">On Leave</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Suspended")">Suspended</MudSelectItem>
                </MudSelect>
            </MudItem>

            <!-- Compensation -->
            <MudItem xs="12">
                <MudText Typo="Typo.h6" Class="mb-2 mt-4">Compensation</MudText>
                <MudDivider Class="mb-4" />
            </MudItem>

            <MudItem xs="12" md="4">
                <MudNumericField @bind-Value="baseSalary"
                                 Label="Base Salary"
                                 Required="true"
                                 Variant="Variant.Outlined"
                                 Min="0"
                                 Step="1000" />
            </MudItem>

            <MudItem xs="12" md="4">
                <MudSelect @bind-Value="currency"
                           Label="Currency"
                           Required="true"
                           Variant="Variant.Outlined"
                           T="string"
                           AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem T="string" Value="@("USD")">USD</MudSelectItem>
                    <MudSelectItem T="string" Value="@("EUR")">EUR</MudSelectItem>
                    <MudSelectItem T="string" Value="@("GBP")">GBP</MudSelectItem>
                    <MudSelectItem T="string" Value="@("ISK")">ISK</MudSelectItem>
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudSelect @bind-Value="paymentFrequency"
                           Label="Payment Frequency"
                           Required="true"
                           Variant="Variant.Outlined"
                           T="string"
                           AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem T="string" Value="@("Monthly")">Monthly</MudSelectItem>
                    <MudSelectItem T="string" Value="@("BiWeekly")">Bi-Weekly</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Weekly")">Weekly</MudSelectItem>
                    <MudSelectItem T="string" Value="@("Hourly")">Hourly</MudSelectItem>
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudNumericField @bind-Value="hoursPerWeek"
                                 Label="Hours Per Week"
                                 Variant="Variant.Outlined"
                                 Min="0"
                                 Max="168"
                                 Step="1" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudCheckBox @bind-Value="isPrimaryJob" Label="Set as Primary Job" Color="Color.Primary" />
            </MudItem>

            <!-- Action Buttons -->
            <MudItem xs="12">
                <MudDivider Class="my-4" />
                <MudStack Row="true" Spacing="2">
                    <MudButton OnClick="HandleSave"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               Disabled="@isSaving"
                               StartIcon="@Icons.Material.Filled.Add">
                        @if (isSaving)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>Adding Job...</span>
                        }
                        else
                        {
                            <span>Add Job</span>
                        }
                    </MudButton>
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Default"
                               OnClick="Cancel"
                               Disabled="@isSaving"
                               StartIcon="@Icons.Material.Filled.Cancel">
                        Cancel
                    </MudButton>
                </MudStack>
            </MudItem>
        </MudGrid>
    </MudPaper>
}

@code {
    [Parameter]
    public int EmployeeId { get; set; }

    private bool isLoading = true;
    private bool isSaving = false;
    private PayrollSystem.Core.Entities.People.Employee? employee;
    private List<Company> companies = new();
    private List<Department> departments = new();
    private List<Department> filteredDepartments = new();

    // Form fields
    private int? selectedCompanyId;
    private int? selectedDepartmentId;
    private string jobTitle = "";
    private string employmentType = "Full-time";
    private string employmentStatus = "Active";
    private DateTime? startDate = DateTime.Today;
    private decimal baseSalary = 0;
    private string currency = "USD";
    private string paymentFrequency = "Monthly";
    private decimal hoursPerWeek = 40;
    private bool isPrimaryJob = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Load employee
            employee = await DbContext.Employees
                .Include(e => e.Employments)
                .FirstOrDefaultAsync(e => e.Id == EmployeeId);

            if (employee == null) return;

            // Load companies (filtered by tenant)
            companies = await DbContext.Companies
                .OrderBy(c => c.CompanyName)
                .ToListAsync();

            // Load all departments
            departments = await DbContext.Departments
                .Include(d => d.Company)
                .OrderBy(d => d.DepartmentName)
                .ToListAsync();

            // If employee has no jobs, set this as primary by default
            if (!employee.Employments.Any())
            {
                isPrimaryJob = true;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
            Snackbar.Add("Failed to load data", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    protected override void OnParametersSet()
    {
        FilterDepartments();
    }

    private void FilterDepartments()
    {
        if (selectedCompanyId.HasValue)
        {
            filteredDepartments = departments
                .Where(d => d.CompanyId == selectedCompanyId.Value)
                .ToList();

            // Clear department selection if it's not valid for the selected company
            if (selectedDepartmentId.HasValue &&
                !filteredDepartments.Any(d => d.Id == selectedDepartmentId.Value))
            {
                selectedDepartmentId = null;
            }
        }
        else
        {
            filteredDepartments = new List<Department>();
            selectedDepartmentId = null;
        }
        StateHasChanged();
    }

    private async Task HandleSave()
    {
        if (employee == null) return;

        // Validate
        if (!selectedCompanyId.HasValue)
        {
            Snackbar.Add("Please select a company", Severity.Error);
            return;
        }

        if (string.IsNullOrWhiteSpace(jobTitle))
        {
            Snackbar.Add("Please enter a job title", Severity.Error);
            return;
        }

        if (!startDate.HasValue)
        {
            Snackbar.Add("Please select a start date", Severity.Error);
            return;
        }

        isSaving = true;
        try
        {
            // If setting as primary, unset other primary jobs
            if (isPrimaryJob)
            {
                var existingPrimaryJobs = await DbContext.Employments
                    .Where(e => e.EmployeeId == EmployeeId && e.IsPrimaryJob)
                    .ToListAsync();

                foreach (var job in existingPrimaryJobs)
                {
                    job.IsPrimaryJob = false;
                }
            }

            // Create new employment
            var employment = new Employment
            {
                EmployeeId = EmployeeId,
                CompanyId = selectedCompanyId.Value,
                DepartmentId = selectedDepartmentId,
                JobTitle = jobTitle.Trim(),
                EmploymentType = employmentType,
                EmploymentStatus = employmentStatus,
                StartDate = startDate.Value,
                BaseSalary = baseSalary,
                Currency = currency,
                PaymentFrequency = paymentFrequency,
                HoursPerWeek = hoursPerWeek,
                IsPrimaryJob = isPrimaryJob,
                WorkLocation = "Office",
                TaxCountry = "United States",
                CreatedAt = DateTime.UtcNow
            };

            DbContext.Employments.Add(employment);
            await DbContext.SaveChangesAsync();

            var companyName = companies.First(c => c.Id == selectedCompanyId.Value).CompanyName;
            Snackbar.Add($"Job added successfully: {jobTitle} at {companyName}", Severity.Success);
            Navigation.NavigateTo($"/employees/{EmployeeId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding job: {ex.Message}");
            Snackbar.Add("Failed to add job. Please try again.", Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo($"/employees/{EmployeeId}");
    }
}
