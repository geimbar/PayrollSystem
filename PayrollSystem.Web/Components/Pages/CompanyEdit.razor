@page "/companies/{CompanyId:int}/edit"
@using PayrollSystem.Core.Entities.Core
@using PayrollSystem.Infrastructure.Data
@using Microsoft.EntityFrameworkCore
@attribute [Authorize]
@rendermode Microsoft.AspNetCore.Components.Web.RenderMode.InteractiveServer
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Edit Company - Payroll System</PageTitle>

@if (isLoading)
{
    <MudProgressCircular Indeterminate="true" />
}
else if (company == null)
{
    <MudAlert Severity="Severity.Error">Company not found</MudAlert>
}
else
{
    <MudText Typo="Typo.h3" Class="mb-2">Edit Company: @company.CompanyName</MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
        Update company information
    </MudText>

    <MudPaper Class="pa-4">
        <MudGrid>
            <!-- Company Information -->
            <MudItem xs="12">
                <MudText Typo="Typo.h6" Class="mb-2">Company Information</MudText>
                <MudDivider Class="mb-4" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="companyName" 
                              Label="Company Name" 
                              Required="true"
                              Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="legalName" 
                              Label="Legal Name" 
                              Required="true"
                              Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="taxId" 
                              Label="Tax ID / EIN" 
                              Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudCheckBox @bind-Value="isActive" 
                             Label="Active" 
                             Color="Color.Primary" />
            </MudItem>

            <!-- Address -->
            <MudItem xs="12">
                <MudText Typo="Typo.h6" Class="mb-2 mt-4">Address</MudText>
                <MudDivider Class="mb-4" />
            </MudItem>

            <MudItem xs="12">
                <MudTextField @bind-Value="address" 
                              Label="Street Address" 
                              Required="true"
                              Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="city" 
                              Label="City" 
                              Required="true"
                              Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="state" 
                              Label="State/Province" 
                              Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="zipCode" 
                              Label="ZIP/Postal Code" 
                              Required="true"
                              Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="country" 
                              Label="Country" 
                              Required="true"
                              Variant="Variant.Outlined" />
            </MudItem>

            <!-- Contact Information -->
            <MudItem xs="12">
                <MudText Typo="Typo.h6" Class="mb-2 mt-4">Contact Information</MudText>
                <MudDivider Class="mb-4" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="phone" 
                              Label="Phone" 
                              Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="email" 
                              Label="Email" 
                              InputType="InputType.Email"
                              Variant="Variant.Outlined" />
            </MudItem>

            <!-- Action Buttons -->
            <MudItem xs="12">
                <MudDivider Class="my-4" />
                <MudStack Row="true" Spacing="2">
                    <MudButton OnClick="HandleSave" 
                               Variant="Variant.Filled" 
                               Color="Color.Primary"
                               Disabled="@isSaving"
                               StartIcon="@Icons.Material.Filled.Save">
                        @if (isSaving)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>Saving...</span>
                        }
                        else
                        {
                            <span>Save Changes</span>
                        }
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" 
                               Color="Color.Default"
                               OnClick="Cancel"
                               Disabled="@isSaving"
                               StartIcon="@Icons.Material.Filled.Cancel">
                        Cancel
                    </MudButton>
                </MudStack>
            </MudItem>
        </MudGrid>
    </MudPaper>
}

@code {
    [Parameter]
    public int CompanyId { get; set; }

    private bool isLoading = true;
    private bool isSaving = false;
    private Company? company;

    // Form fields
    private string companyName = "";
    private string legalName = "";
    private string taxId = "";
    private string address = "";
    private string city = "";
    private string state = "";
    private string zipCode = "";
    private string country = "";
    private string phone = "";
    private string email = "";
    private bool isActive = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            company = await DbContext.Companies
                .FirstOrDefaultAsync(c => c.Id == CompanyId);

            if (company == null) return;

            // Populate form fields
            companyName = company.CompanyName;
            legalName = company.LegalName;
            taxId = company.TaxId ?? "";
            address = company.Address;
            city = company.City;
            state = company.State ?? "";
            zipCode = company.ZipCode;
            country = company.Country;
            phone = company.Phone ?? "";
            email = company.Email ?? "";
            isActive = company.IsActive;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading company: {ex.Message}");
            Snackbar.Add("Failed to load company", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleSave()
    {
        if (company == null) return;

        // Validate
        if (string.IsNullOrWhiteSpace(companyName))
        {
            Snackbar.Add("Please enter a company name", Severity.Error);
            return;
        }

        if (string.IsNullOrWhiteSpace(legalName))
        {
            Snackbar.Add("Please enter a legal name", Severity.Error);
            return;
        }

        if (string.IsNullOrWhiteSpace(address) || string.IsNullOrWhiteSpace(city) || 
            string.IsNullOrWhiteSpace(zipCode) || string.IsNullOrWhiteSpace(country))
        {
            Snackbar.Add("Please fill in all address fields", Severity.Error);
            return;
        }

        isSaving = true;
        try
        {
            // Update company
            company.CompanyName = companyName.Trim();
            company.LegalName = legalName.Trim();
            company.TaxId = taxId?.Trim() ?? string.Empty;
            company.Address = address.Trim();
            company.City = city.Trim();
            company.State = state?.Trim() ?? string.Empty;
            company.ZipCode = zipCode.Trim();
            company.Country = country.Trim();
            company.Phone = phone?.Trim() ?? string.Empty;
            company.Email = email?.Trim() ?? string.Empty;
            company.IsActive = isActive;
            company.UpdatedAt = DateTime.UtcNow;

            await DbContext.SaveChangesAsync();

            Snackbar.Add($"Company '{companyName}' updated successfully", Severity.Success);
            Navigation.NavigateTo($"/companies/{CompanyId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating company: {ex.Message}");
            Snackbar.Add("Failed to update company. Please try again.", Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo($"/companies/{CompanyId}");
    }
}
