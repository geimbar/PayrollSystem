@page "/departments"
@using PayrollSystem.Core.Entities.Core
@using PayrollSystem.Infrastructure.Data
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize]
@rendermode Microsoft.AspNetCore.Components.Web.RenderMode.InteractiveServer
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Departments - Payroll System</PageTitle>

<MudText Typo="Typo.h3" Class="mb-4">Departments</MudText>

<div class="d-flex justify-space-between align-center mb-4">
    <MudTextField @bind-Value="searchString"
                  Placeholder="Search departments..."
                  Adornment="Adornment.Start"
                  AdornmentIcon="@Icons.Material.Filled.Search"
                  IconSize="Size.Medium"
                  Variant="Variant.Outlined"
                  Clearable="true"
                  Style="max-width: 400px;"
                  Immediate="true"
                  DebounceInterval="300"></MudTextField>
    <MudButton Variant="Variant.Filled"
               Color="Color.Primary"
               StartIcon="@Icons.Material.Filled.Add"
               Href="/departments/create">
        Create Department
    </MudButton>
</div>

@if (!string.IsNullOrEmpty(scopeInfo))
{
    <MudAlert Severity="Severity.Info" Class="mb-4">@scopeInfo</MudAlert>
}

@if (isLoading)
{
    <MudProgressCircular Indeterminate="true" />
}
else
{
    <MudTable Items="@filteredDepartments" Hover="true" Striped="true" Dense="true">
        <HeaderContent>
            <MudTh>ID</MudTh>
            <MudTh>Department Name</MudTh>
            <MudTh>Company</MudTh>
            <MudTh>Code</MudTh>
            <MudTh># Employees</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="ID">@context.Id</MudTd>
            <MudTd DataLabel="Department Name">@context.DepartmentName</MudTd>
            <MudTd DataLabel="Company">@context.Company.CompanyName</MudTd>
            <MudTd DataLabel="Code">@context.DepartmentCode</MudTd>
            <MudTd DataLabel="# Employees">@context.Employments.Count</MudTd>
            <MudTd DataLabel="Actions">
                <MudStack Row="true" Spacing="1">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                   Size="Size.Small"
                                   Color="Color.Primary"
                                   Href="@($"/departments/{context.Id}/edit")"
                                   Title="Edit Department" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                   Size="Size.Small"
                                   Color="Color.Error"
                                   OnClick="@(() => ShowDeleteDialog(context))"
                                   Title="Delete Department" />
                </MudStack>
            </MudTd>
        </RowTemplate>
    </MudTable>

    <MudText Typo="Typo.body2" Class="mt-4">
        Showing @filteredDepartments.Count of @departments.Count department(s)
    </MudText>

    <MudButton Href="/" Variant="Variant.Text" Class="mt-4">
        <MudIcon Icon="@Icons.Material.Filled.ArrowBack" Class="mr-2" />
        Back to Dashboard
    </MudButton>
}

<!-- Delete Confirmation Dialog -->
@if (showDeleteConfirmation && departmentToDelete != null)
{
    <MudOverlay Visible="true" ZIndex="9999">
        <MudPaper Class="pa-6" Style="max-width: 500px;">
            <MudText Typo="Typo.h6" Class="mb-4">Delete Department</MudText>
            <MudText Class="mb-4">
                Are you sure you want to delete <strong>@departmentToDelete.DepartmentName</strong>?
            </MudText>
            @if (departmentToDelete.Employments.Any())
            {
                <MudAlert Severity="Severity.Warning" Class="mb-4">
                    This department has @departmentToDelete.Employments.Count employee(s). You cannot delete it.
                </MudAlert>
            }
            <MudStack Row="true" Spacing="2" Justify="Justify.FlexEnd">
                <MudButton OnClick="CancelDelete" Variant="Variant.Outlined">Cancel</MudButton>
                <MudButton OnClick="ConfirmDelete"
                           Color="Color.Error"
                           Variant="Variant.Filled"
                           Disabled="@departmentToDelete.Employments.Any()">
                    Delete
                </MudButton>
            </MudStack>
        </MudPaper>
    </MudOverlay>
}

@code {
    private bool isLoading = true;
    private List<Department> departments = new();
    private List<Department> filteredDepartments = new();
    private string searchString = "";
    private string scopeInfo = "";
    private int? userCompanyId = null;
    private bool showDeleteConfirmation = false;
    private Department? departmentToDelete;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            var companyIdClaim = user.FindFirst("CompanyId")?.Value;
            if (!string.IsNullOrEmpty(companyIdClaim) && int.TryParse(companyIdClaim, out int companyId))
            {
                userCompanyId = companyId;
                var company = await DbContext.Companies
                    .IgnoreQueryFilters()
                    .FirstOrDefaultAsync(c => c.Id == companyId);
                scopeInfo = $"Viewing departments for: {company?.CompanyName ?? "Unknown Company"}";
            }
            else
            {
                scopeInfo = "Viewing all departments across all companies";
            }

            var query = DbContext.Departments
                .Include(d => d.Company)
                .Include(d => d.Employments)
                .AsQueryable();

            if (userCompanyId.HasValue)
            {
                query = query.Where(d => d.CompanyId == userCompanyId.Value);
            }

            departments = await query
                .OrderBy(d => d.Company.CompanyName)
                .ThenBy(d => d.DepartmentName)
                .ToListAsync();

            FilterDepartments();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading departments: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    protected override void OnParametersSet()
    {
        FilterDepartments();
    }

    private void FilterDepartments()
    {
        if (string.IsNullOrWhiteSpace(searchString))
        {
            filteredDepartments = departments;
        }
        else
        {
            var search = searchString.ToLower();
            filteredDepartments = departments.Where(d =>
                d.DepartmentName.ToLower().Contains(search) ||
                d.DepartmentCode.ToLower().Contains(search) ||
                d.Company.CompanyName.ToLower().Contains(search)
            ).ToList();
        }
        StateHasChanged();
    }

    private void ShowDeleteDialog(Department department)
    {
        departmentToDelete = department;
        showDeleteConfirmation = true;
    }

    private void CancelDelete()
    {
        departmentToDelete = null;
        showDeleteConfirmation = false;
    }

    private async Task ConfirmDelete()
    {
        if (departmentToDelete == null) return;

        try
        {
            DbContext.Departments.Remove(departmentToDelete);
            await DbContext.SaveChangesAsync();

            departments.Remove(departmentToDelete);
            FilterDepartments();

            departmentToDelete = null;
            showDeleteConfirmation = false;

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting department: {ex.Message}");
        }
    }
}
