@page "/companies/create"
@using PayrollSystem.Core.Entities.Core
@using PayrollSystem.Infrastructure.Data
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize]
@rendermode Microsoft.AspNetCore.Components.Web.RenderMode.InteractiveServer
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Create Company - Payroll System</PageTitle>

<MudText Typo="Typo.h3" Class="mb-4">Create New Company</MudText>

<MudPaper Class="pa-4">
    <MudGrid>
        <!-- Company Information -->
        <MudItem xs="12">
            <MudText Typo="Typo.h6" Class="mb-2">Company Information</MudText>
            <MudDivider Class="mb-4" />
        </MudItem>

        <MudItem xs="12" md="6">
            <MudTextField @bind-Value="companyName"
                          Label="Company Name"
                          Required="true"
                          Variant="Variant.Outlined"
                          Placeholder="e.g., Acme Corporation" />
        </MudItem>

        <MudItem xs="12" md="6">
            <MudTextField @bind-Value="legalName"
                          Label="Legal Name"
                          Required="true"
                          Variant="Variant.Outlined"
                          Placeholder="e.g., Acme Corporation Inc." />
        </MudItem>

        <MudItem xs="12" md="6">
            <MudTextField @bind-Value="taxId"
                          Label="Tax ID / EIN"
                          Variant="Variant.Outlined"
                          Placeholder="e.g., 12-3456789" />
        </MudItem>

        <!-- Address -->
        <MudItem xs="12">
            <MudText Typo="Typo.h6" Class="mb-2 mt-4">Address</MudText>
            <MudDivider Class="mb-4" />
        </MudItem>

        <MudItem xs="12">
            <MudTextField @bind-Value="address"
                          Label="Street Address"
                          Required="true"
                          Variant="Variant.Outlined" />
        </MudItem>

        <MudItem xs="12" md="4">
            <MudTextField @bind-Value="city"
                          Label="City"
                          Required="true"
                          Variant="Variant.Outlined" />
        </MudItem>

        <MudItem xs="12" md="4">
            <MudTextField @bind-Value="state"
                          Label="State/Province"
                          Variant="Variant.Outlined" />
        </MudItem>

        <MudItem xs="12" md="4">
            <MudTextField @bind-Value="zipCode"
                          Label="ZIP/Postal Code"
                          Required="true"
                          Variant="Variant.Outlined" />
        </MudItem>

        <MudItem xs="12" md="6">
            <MudTextField @bind-Value="country"
                          Label="Country"
                          Required="true"
                          Variant="Variant.Outlined" />
        </MudItem>

        <!-- Contact Information -->
        <MudItem xs="12">
            <MudText Typo="Typo.h6" Class="mb-2 mt-4">Contact Information</MudText>
            <MudDivider Class="mb-4" />
        </MudItem>

        <MudItem xs="12" md="6">
            <MudTextField @bind-Value="phone"
                          Label="Phone"
                          Variant="Variant.Outlined" />
        </MudItem>

        <MudItem xs="12" md="6">
            <MudTextField @bind-Value="email"
                          Label="Email"
                          InputType="InputType.Email"
                          Variant="Variant.Outlined" />
        </MudItem>

        <!-- Action Buttons -->
        <MudItem xs="12">
            <MudDivider Class="my-4" />
            <MudStack Row="true" Spacing="2">
                <MudButton OnClick="HandleSave"
                           Variant="Variant.Filled"
                           Color="Color.Primary"
                           Disabled="@isSaving"
                           StartIcon="@Icons.Material.Filled.Add">
                    @if (isSaving)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <span>Creating...</span>
                    }
                    else
                    {
                        <span>Create Company</span>
                    }
                </MudButton>
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Default"
                           OnClick="Cancel"
                           Disabled="@isSaving"
                           StartIcon="@Icons.Material.Filled.Cancel">
                    Cancel
                </MudButton>
            </MudStack>
        </MudItem>
    </MudGrid>
</MudPaper>

@code {
    private bool isSaving = false;

    // Form fields - ONLY properties that exist in Company entity
    private string companyName = "";
    private string legalName = "";
    private string taxId = "";
    private string address = "";
    private string city = "";
    private string state = "";
    private string zipCode = "";
    private string country = "United States";
    private string phone = "";
    private string email = "";

    private async Task HandleSave()
    {
        // Validate required fields
        if (string.IsNullOrWhiteSpace(companyName))
        {
            Snackbar.Add("Please enter a company name", Severity.Error);
            return;
        }

        if (string.IsNullOrWhiteSpace(legalName))
        {
            Snackbar.Add("Please enter a legal name", Severity.Error);
            return;
        }

        if (string.IsNullOrWhiteSpace(address) || string.IsNullOrWhiteSpace(city) ||
            string.IsNullOrWhiteSpace(zipCode) || string.IsNullOrWhiteSpace(country))
        {
            Snackbar.Add("Please fill in all address fields", Severity.Error);
            return;
        }

        isSaving = true;
        try
        {
            // Get tenant ID from claims
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            var tenantClaim = user.FindFirst("TenantId");

            if (tenantClaim == null || !int.TryParse(tenantClaim.Value, out int tenantId))
            {
                Snackbar.Add("Unable to determine tenant. Please log out and log back in.", Severity.Error);
                return;
            }

            var company = new Company
            {
                TenantId = tenantId,
                CompanyName = companyName.Trim(),
                LegalName = legalName.Trim(),
                TaxId = taxId?.Trim() ?? string.Empty,
                Address = address.Trim(),
                City = city.Trim(),
                State = state?.Trim() ?? string.Empty,
                ZipCode = zipCode.Trim(),
                Country = country.Trim(),
                Phone = phone?.Trim() ?? string.Empty,
                Email = email?.Trim() ?? string.Empty,
                IsActive = true,
                CreatedAt = DateTime.UtcNow
            };

            DbContext.Companies.Add(company);
            await DbContext.SaveChangesAsync();

            Snackbar.Add($"Company '{companyName}' created successfully", Severity.Success);
            Navigation.NavigateTo($"/companies/{company.Id}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating company: {ex.Message}");
            Snackbar.Add("Failed to create company. Please try again.", Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/companies");
    }
}
